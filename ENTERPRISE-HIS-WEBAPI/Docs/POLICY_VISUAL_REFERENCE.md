# ?? POLICY MAPPING VISUAL REFERENCE GUIDE

## Quick Reference: Which Role Can Access Which Endpoint

---

## ?? Lookup Management Endpoints

### **View Lookups** `[Authorize(Policy = "CanViewLookups")]`

```
GET /api/v1/lookuptypes
GET /api/v1/lookuptypes/{id}
GET /api/v1/lookuptypes/code/{code}
GET /api/v1/lookuptypes/search
GET /api/v1/lookuptypes/count

Role Access Matrix:
??????????????????????????????????????????????????
? Role        ? Access                           ?
??????????????????????????????????????????????????
? Admin       ? ? YES (has all policies)        ?
? Manager     ? ? YES (has VIEW_LOOKUPS)        ?
? User        ? ? YES (has VIEW_LOOKUPS)        ?
? Viewer      ? ? YES (has VIEW_LOOKUPS)        ?
? Anonymous   ? ? NO (not authenticated)        ?
??????????????????????????????????????????????????

HTTP Response:
? 200 OK (authorized)
? 401 Unauthorized (no token)
? 403 Forbidden (no policy)
```

---

### **Create Lookups** `[Authorize(Policy = "CanManageLookups")]`

```
POST /api/v1/lookuptypes
PUT /api/v1/lookuptypes/{id}

Role Access Matrix:
??????????????????????????????????????????????????
? Role        ? Access                           ?
??????????????????????????????????????????????????
? Admin       ? ? YES (has MANAGE_LOOKUPS)      ?
? Manager     ? ? YES (has MANAGE_LOOKUPS)      ?
? User        ? ? NO (doesn't have policy)      ?
? Viewer      ? ? NO (doesn't have policy)      ?
? Anonymous   ? ? NO (not authenticated)        ?
??????????????????????????????????????????????????

HTTP Response:
? 201 Created (authorized)
? 200 OK (authorized - update)
? 401 Unauthorized (no token)
? 403 Forbidden (no policy)
```

---

### **Delete Lookups** `[Authorize(Policy = "CanDeleteLookups")]`

```
DELETE /api/v1/lookuptypes/{id}

Role Access Matrix:
??????????????????????????????????????????????????
? Role        ? Access                           ?
??????????????????????????????????????????????????
? Admin       ? ? YES (has DELETE_LOOKUPS)      ?
? Manager     ? ? NO (doesn't have policy)      ?
? User        ? ? NO (doesn't have policy)      ?
? Viewer      ? ? NO (doesn't have policy)      ?
? Anonymous   ? ? NO (not authenticated)        ?
??????????????????????????????????????????????????

HTTP Response:
? 200 OK (authorized)
? 401 Unauthorized (no token)
? 403 Forbidden (no policy)
```

---

## ?? User Management Endpoints

### **View Users** `[Authorize(Policy = "CanViewUsers")]`

```
GET /api/v1/users
GET /api/v1/users/{id}
GET /api/v1/users/username/{username}

Role Access Matrix:
??????????????????????????????????????????????????
? Role        ? Access                           ?
??????????????????????????????????????????????????
? Admin       ? ? YES (has VIEW_USERS)          ?
? Manager     ? ? YES (has VIEW_USERS)          ?
? User        ? ? NO (doesn't have policy)      ?
? Viewer      ? ? NO (doesn't have policy)      ?
? Anonymous   ? ? NO (not authenticated)        ?
??????????????????????????????????????????????????
```

---

### **Create/Edit Users** `[Authorize(Policy = "CanManageUsers")]`

```
POST /api/v1/users
PUT /api/v1/users/{id}

Role Access Matrix:
??????????????????????????????????????????????????
? Role        ? Access                           ?
??????????????????????????????????????????????????
? Admin       ? ? YES (has MANAGE_USERS)        ?
? Manager     ? ? NO (doesn't have policy)      ?
? User        ? ? NO (doesn't have policy)      ?
? Viewer      ? ? NO (doesn't have policy)      ?
? Anonymous   ? ? NO (not authenticated)        ?
??????????????????????????????????????????????????
```

---

### **Delete Users** `[Authorize(Policy = "CanDeleteUsers")]`

```
DELETE /api/v1/users/{id}

Role Access Matrix:
??????????????????????????????????????????????????
? Role        ? Access                           ?
??????????????????????????????????????????????????
? Admin       ? ? YES (has DELETE_USERS)        ?
? Manager     ? ? NO (doesn't have policy)      ?
? User        ? ? NO (doesn't have policy)      ?
? Viewer      ? ? NO (doesn't have policy)      ?
? Anonymous   ? ? NO (not authenticated)        ?
??????????????????????????????????????????????????
```

---

### **Manage Roles** `[Authorize(Policy = "ManageRoles")]`

```
POST /api/v1/users/{id}/roles
DELETE /api/v1/users/{id}/roles/{roleId}

Role Access Matrix:
??????????????????????????????????????????????????
? Role        ? Access                           ?
??????????????????????????????????????????????????
? Admin       ? ? YES (has MANAGE_ROLES)        ?
? Manager     ? ? NO (doesn't have policy)      ?
? User        ? ? NO (doesn't have policy)      ?
? Viewer      ? ? NO (doesn't have policy)      ?
? Anonymous   ? ? NO (not authenticated)        ?
??????????????????????????????????????????????????
```

---

## ?? Complete Endpoint-to-Policy Mapping Table

| HTTP | Endpoint | Policy Required | Admin | Manager | User | Viewer | Anon |
|------|----------|-----------------|-------|---------|------|--------|------|
| GET | /lookuptypes | CanViewLookups | ? | ? | ? | ? | ? |
| GET | /lookuptypes/{id} | CanViewLookups | ? | ? | ? | ? | ? |
| GET | /lookuptypes/code/{code} | CanViewLookups | ? | ? | ? | ? | ? |
| GET | /lookuptypes/search | CanViewLookups | ? | ? | ? | ? | ? |
| GET | /lookuptypes/count | CanViewLookups | ? | ? | ? | ? | ? |
| POST | /lookuptypes | CanManageLookups | ? | ? | ? | ? | ? |
| PUT | /lookuptypes/{id} | CanManageLookups | ? | ? | ? | ? | ? |
| DELETE | /lookuptypes/{id} | CanDeleteLookups | ? | ? | ? | ? | ? |
| GET | /lookuptypevalues | CanViewLookups | ? | ? | ? | ? | ? |
| GET | /lookuptypevalues/{id} | CanViewLookups | ? | ? | ? | ? | ? |
| POST | /lookuptypevalues | CanManageLookups | ? | ? | ? | ? | ? |
| PUT | /lookuptypevalues/{id} | CanManageLookups | ? | ? | ? | ? | ? |
| DELETE | /lookuptypevalues/{id} | CanDeleteLookups | ? | ? | ? | ? | ? |
| GET | /users | CanViewUsers | ? | ? | ? | ? | ? |
| GET | /users/{id} | [Authorize] | ? | ? | ? | ? | ? |
| GET | /users/username/{username} | [Authorize] | ? | ? | ? | ? | ? |
| POST | /users | CanManageUsers | ? | ? | ? | ? | ? |
| PUT | /users/{id} | CanManageUsers | ? | ? | ? | ? | ? |
| DELETE | /users/{id} | CanDeleteUsers | ? | ? | ? | ? | ? |
| POST | /users/{id}/roles | ManageRoles | ? | ? | ? | ? | ? |
| DELETE | /users/{id}/roles/{roleId} | ManageRoles | ? | ? | ? | ? | ? |
| POST | /users/{id}/change-password | [Authorize] | ? | ? | ? | ? | ? |

---

## ?? Policy Enforcement Flow (Diagram)

```
???????????????????????????????????????
? Client Request                      ?
? POST /api/v1/lookuptypes            ?
? Authorization: Bearer <token>       ?
???????????????????????????????????????
                 ?
     ?????????????????????????????
     ? Check JWT Token           ?
     ? ? Valid? Continue        ?
     ? ? Invalid? 401 Unauth    ?
     ?????????????????????????????
                 ?
     ?????????????????????????????
     ? Check [Authorize] attr    ?
     ? ? Present? Continue      ?
     ? ? Missing? 401           ?
     ?????????????????????????????
                 ?
     ?????????????????????????????
     ? Check Policy Required     ?
     ? ? Policy set? Continue   ?
     ? ? No policy? Allow (*)   ?
     ?????????????????????????????
                 ?
     ?????????????????????????????????????
     ? DatabasePolicyHandler runs        ?
     ? 1. Extract userId from JWT        ?
     ? 2. Get user's role                ?
     ? 3. Get role's policies (from DB)  ?
     ? 4. Check if policy in list        ?
     ?????????????????????????????????????
                 ?
        ???????????????????
        ?                 ?
   ? FOUND        ? NOT FOUND
   Allow           Deny (403)
   Continue        Return Error
        ?                 ?
   Execute          Response
   Method           403 Forbidden
        ?
   Return 200/201
```

---

## ?? Test Commands by Role

### **Admin User**
```bash
# Login
TOKEN=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | jq -r '.token')

# Can View
curl -X GET http://localhost:5000/api/v1/lookuptypes \
  -H "Authorization: Bearer $TOKEN"
# Result: ? 200 OK

# Can Create
curl -X POST http://localhost:5000/api/v1/lookuptypes \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"name":"Test"}'
# Result: ? 201 Created

# Can Delete
curl -X DELETE http://localhost:5000/api/v1/lookuptypes/1 \
  -H "Authorization: Bearer $TOKEN"
# Result: ? 200 OK
```

### **Manager User**
```bash
# Login
TOKEN=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -d '{"username":"manager","password":"manager123"}' | jq -r '.token')

# Can View ?
curl -X GET http://localhost:5000/api/v1/lookuptypes \
  -H "Authorization: Bearer $TOKEN"
# Result: ? 200 OK

# Can Create ?
curl -X POST http://localhost:5000/api/v1/lookuptypes \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"name":"Test"}'
# Result: ? 201 Created

# Cannot Delete ?
curl -X DELETE http://localhost:5000/api/v1/lookuptypes/1 \
  -H "Authorization: Bearer $TOKEN"
# Result: ? 403 Forbidden
```

### **User (Regular)**
```bash
# Login
TOKEN=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -d '{"username":"user","password":"user123"}' | jq -r '.token')

# Can View ?
curl -X GET http://localhost:5000/api/v1/lookuptypes \
  -H "Authorization: Bearer $TOKEN"
# Result: ? 200 OK

# Cannot Create ?
curl -X POST http://localhost:5000/api/v1/lookuptypes \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"name":"Test"}'
# Result: ? 403 Forbidden

# Cannot Delete ?
curl -X DELETE http://localhost:5000/api/v1/lookuptypes/1 \
  -H "Authorization: Bearer $TOKEN"
# Result: ? 403 Forbidden
```

### **Viewer User**
```bash
# Login
TOKEN=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -d '{"username":"viewer","password":"viewer123"}' | jq -r '.token')

# Can View Lookups Only ?
curl -X GET http://localhost:5000/api/v1/lookuptypes \
  -H "Authorization: Bearer $TOKEN"
# Result: ? 200 OK

# Cannot View Users ?
curl -X GET http://localhost:5000/api/v1/users \
  -H "Authorization: Bearer $TOKEN"
# Result: ? 403 Forbidden

# Cannot Create ?
# Cannot Delete ?
```

---

## ?? Policy Summary Table

| Policy | Code | Lookups | Users | Admin | Create | Delete | View |
|--------|------|---------|-------|-------|--------|--------|------|
| CanViewLookups | VIEW_LOOKUPS | ? | ? | ? | ? | ? | ? |
| CanManageLookups | MANAGE_LOOKUPS | ? | ? | ? | ? | ? | ? |
| CanDeleteLookups | DELETE_LOOKUPS | ? | ? | ? | ? | ? | ? |
| CanViewUsers | VIEW_USERS | ? | ? | ? | ? | ? | ? |
| CanManageUsers | MANAGE_USERS | ? | ? | ? | ? | ? | ? |
| CanDeleteUsers | DELETE_USERS | ? | ? | ? | ? | ? | ? |
| ManageRoles | MANAGE_ROLES | ? | ? | ? | ? | ? | ? |
| AdminOnly | ADMIN_ONLY | ? | ? | ? | ? | ? | ? |

Legend:
- ? = Admin has this policy
- ? = Not admin-only

---

## ?? Key Points

1. **Every endpoint** requires authentication `[Authorize]`
2. **Most endpoints** require a specific policy `[Authorize(Policy = "...")]`
3. **Policies are in database** `master.PolicyMaster`
4. **Role-policy assignments** are in database `config.RolePolicyMapping`
5. **In-memory cache** for performance (O(1) lookups)
6. **No hardcoding** - change policies via API
7. **Runtime changes** - no redeploy needed
8. **Admin can do everything** - has all policies

---

**Use this guide to understand how policies work on each endpoint!** ??
