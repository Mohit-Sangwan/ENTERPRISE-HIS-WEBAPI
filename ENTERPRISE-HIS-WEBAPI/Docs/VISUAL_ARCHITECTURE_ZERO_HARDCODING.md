# ?? VISUAL ARCHITECTURE: Zero Hardcoding Authorization System

## Request Flow Diagram

```
HTTP Request arrives at LookupController
        ?
????????????????????????????????????????????????????????????????
? [Authorize(Policy = "Lookups.Delete")]                       ?
?                                                               ?
? This is a PLAIN STRING LITERAL                               ?
? NOT a reference to a constant!                               ?
? NOT defined in code anywhere!                                ?
????????????????????????????????????????????????????????????????
                   ?
????????????????????????????????????????????????????????????????
? DynamicPolicyProvider.GetPolicyAsync("Lookups.Delete")      ?
?                                                               ?
? Intercepts at request time                                   ?
? Parses string: "Lookups.Delete"                             ?
????????????????????????????????????????????????????????????????
                   ?
????????????????????????????????????????????????????????????????
? Extract Module and Operation                                 ?
?                                                               ?
? "Lookups.Delete".Split('.')                                 ?
?   ?                                                           ?
?   module = "Lookups"                                         ?
?   operation = "Delete"                                       ?
????????????????????????????????????????????????????????????????
                   ?
????????????????????????????????????????????????????????????????
? Create DynamicModuleOperationRequirement                     ?
?                                                               ?
? new DynamicModuleOperationRequirement(                       ?
?   module: "Lookups",                                         ?
?   operation: "Delete"                                        ?
? )                                                             ?
?                                                               ?
? Constructs: PolicyName = "Lookups.Delete"                  ?
????????????????????????????????????????????????????????????????
                   ?
????????????????????????????????????????????????????????????????
? DynamicModuleOperationHandler processes requirement          ?
?                                                               ?
? Extract userId from JWT claims                              ?
? Get PolicyName: "Lookups.Delete"                           ?
????????????????????????????????????????????????????????????????
                   ?
        ????????????????????????
        ? Query Database       ?
        ? (at request time)    ?
        ????????????????????????
                       ?
       ?????????????????????????????????????
       ? Step 1: Find Policy               ?
       ?                                    ?
       ? SELECT PolicyId FROM              ?
       ?   master.PolicyMaster             ?
       ? WHERE PolicyName =                ?
       ?   "Lookups.Delete"               ?
       ?                                    ?
       ? Result: PolicyId = 5              ?
       ???????????????????????????????????
                       ?
       ?????????????????????????????????????
       ? Step 2: Get User's Roles          ?
       ?                                    ?
       ? SELECT RoleId FROM                ?
       ?   master.UserRoleMaster           ?
       ? WHERE UserId = {userId}           ?
       ?                                    ?
       ? Result: RoleId IN (1,2)           ?
       ?         (Admin, Manager)           ?
       ???????????????????????????????????
                       ?
       ?????????????????????????????????????
       ? Step 3: Check Role-Policy Map     ?
       ?                                    ?
       ? SELECT * FROM                     ?
       ?   config.RolePolicyMapping        ?
       ? WHERE RoleId IN (1, 2)            ?
       ? AND PolicyId = 5                  ?
       ?                                    ?
       ? Found? ? YES (for Admin)          ?
       ???????????????????????????????????
                       ?
????????????????????????????????????????????????????????????????
?                     RESULT                                    ?
?                                                               ?
?  User has permission for "Lookups.Delete"                  ?
?  context.Succeed(requirement)                               ?
????????????????????????????????????????????????????????????????
                   ?
        ????????????????????????????
        ?  Authorization Passed    ?
        ?  Request continues...    ?
        ?  Endpoint executed       ?
        ?  Response: 200 OK        ?
        ????????????????????????????
```

---

## System Architecture

```
??????????????????????????????????????????????????????????????????
?                    APPLICATION LAYER                           ?
?                                                                 ?
?  ???????????????????????????????????????????????????????????? ?
?  ? Controllers                                              ? ?
?  ?                                                          ? ?
?  ? [Authorize(Policy = "Lookups.Delete")]                ? ?
?  ? [HttpDelete]                                           ? ?
?  ? public Delete(int id) { }                             ? ?
?  ?                                                          ? ?
?  ? Policy is a PLAIN STRING - NOT a constant!            ? ?
?  ? NOT hardcoded anywhere in code!                        ? ?
?  ???????????????????????????????????????????????????????? ?
?               ?                                            ?
?  ???????????????????????????????????????????????????????? ?
?  ? Authorization Middleware                             ? ?
?  ? (DynamicPolicyProvider + DynamicModuleOperationHandler)
?  ?                                                          ? ?
?  ? • Intercepts request                                  ? ?
?  ? • Parses policy name at runtime                       ? ?
?  ? • Extracts Module and Operation                       ? ?
?  ? • NO constants referenced                             ? ?
?  ???????????????????????????????????????????????????????? ?
?               ?                                            ?
??????????????????????????????????????????????????????????????
                ?
        ??????????????????
        ?                ?
???????????????????? ????????????????????????????????
?  Authorization   ? ?   Database Layer             ?
?  Requirements    ? ?   (Source of Truth)          ?
?                  ? ?                              ?
? Module="Lookups" ? ? master.PolicyMaster          ?
? Operation=       ? ? ?? PolicyId                  ?
?   "Delete"       ? ? ?? PolicyName                ?
? PolicyName=      ? ? ?? Module                    ?
? "Lookups.Delete" ? ? ?? IsActive                  ?
???????????????????? ?                              ?
         ?            ? config.RolePolicyMapping    ?
         ?            ? ?? RoleId                   ?
         ?????????????? ?? PolicyId                 ?
         ?            ? ?? AssignedAt               ?
         ?            ?                              ?
         ?            ? master.UserRoleMaster       ?
         ?            ? ?? UserId                   ?
         ?            ? ?? RoleId                   ?
         ?            ?? AssignedAt                 ?
         ?
         ?????? Result: Allow ? or Deny ?
```

---

## Data Model

```
master.PolicyMaster (All policies here - ZERO in code!)
???????????????????????????????????????????????????????????????
? ID   ? PolicyName       ? Module     ? Operation ? IsActive ?
???????????????????????????????????????????????????????????????
? 1    ? Lookups.View     ? Lookups    ? View      ? 1        ?
? 2    ? Lookups.Print    ? Lookups    ? Print     ? 1        ?
? 3    ? Lookups.Create   ? Lookups    ? Create    ? 1        ?
? 4    ? Lookups.Edit     ? Lookups    ? Edit      ? 1        ?
? 5    ? Lookups.Delete   ? Lookups    ? Delete    ? 1        ?
? 6    ? Lookups.Manage   ? Lookups    ? Manage    ? 1        ?
? 7    ? Lookups.Admin    ? Lookups    ? Admin     ? 1        ?
? 8    ? Users.View       ? Users      ? View      ? 1        ?
? 9    ? Users.Create     ? Users      ? Create    ? 1        ?
? ...  ? ...              ? ...        ? ...       ? ...      ?
???????????????????????????????????????????????????????????????
                  ?
         Every policy here!
         ZERO in code!


config.RolePolicyMapping (Who has what policy?)
???????????????????????????????????
? RoleId   ? PolicyId  ? AssignedAt?
???????????????????????????????????
? 1 (Admin)? 1-42      ? ...      ?  All policies
? 2 (Mgr)  ? 1,2,3,4,6 ? ...      ?  NO Delete/Admin
? 3 (User) ? 1,2,8,... ? ...      ?  View, Print only
? 4 (View) ? 1,8,...   ? ...      ?  View only
???????????????????????????????????
        ?
 Authorization checks here
 at request time!


master.UserRoleMaster (Which user has which role?)
??????????????????????????????
? UserId ? RoleId ? AssignedAt?
??????????????????????????????
? 1      ? 1      ? ...      ?  User 1 is Admin
? 2      ? 2      ? ...      ?  User 2 is Manager
? 3      ? 3      ? ...      ?  User 3 is User
? 4      ? 4      ? ...      ?  User 4 is Viewer
??????????????????????????????
        ?
 JWT token references this
```

---

## Code Organization (Zero Hardcoding!)

```
ENTERPRISE-HIS-WEBAPI/
?
??? Controllers/
?   ??? LookupController.cs
?   ?   ??? [Authorize(Policy = "Lookups.View")]     ? NO constants!
?   ?   ??? [Authorize(Policy = "Lookups.Create")]   ? NO constants!
?   ?   ??? [Authorize(Policy = "Lookups.Delete")]   ? NO constants!
?   ?
?   ??? UsersController.cs
?       ??? [Authorize(Policy = "Users.View")]       ? NO constants!
?       ??? [Authorize(Policy = "Users.Create")]     ? NO constants!
?
??? Authorization/
?   ??? DynamicPolicyProvider.cs
?   ?   ??? Parses "Module.Operation" format
?   ?   ??? Creates DynamicModuleOperationRequirement
?   ?   ??? NO hardcoded policy names!
?   ?
?   ??? DynamicModuleOperationHandler.cs
?   ?   ??? Handles requirements at runtime
?   ?   ??? Queries database for policy
?   ?   ??? Checks user's role-policy mapping
?   ?
?   ??? (NO PolicyConstants.cs - NOT NEEDED!)
?
??? Constants/
?   ??? (Removed: PolicyConstants.cs - All policies in DB!)
?
??? Database/
    ??? 03_ModuleBasedPoliciesMigration.sql
        ??? All 42 policies pre-loaded!
```

---

## Comparison: Parsing Flow

### ? OLD (Constants-based)
```
Controller:
  [Authorize(Policy = ModulePolicyConstants.Lookups.DELETE)]
        ?
Constants resolved at COMPILE TIME
  const string DELETE = "Lookups.Delete"
        ?
Policy name is hardcoded in const
        ?
Still hardcoding! ?
```

### ? NEW (Runtime-parsed)
```
Controller:
  [Authorize(Policy = "Lookups.Delete")]
        ?
String parsed at REQUEST TIME
  "Lookups.Delete".Split('.')
  ? module = "Lookups"
  ? operation = "Delete"
        ?
Database validates policy name
        ?
Zero hardcoding! ?
```

---

## Authorization Decision Tree

```
                 User makes request
                        ?
                   Has JWT token?
                    ?         ?
                  NO          YES
                  ?            ?
               403         Extract user ID
                           from JWT
                                ?
                        DynamicPolicyProvider
                        Intercepts policy name
                        "Lookups.Delete"
                                ?
                        Parse: Module.Operation
                        Module="Lookups"
                        Operation="Delete"
                                ?
                        Create requirement
                                ?
                        DynamicModuleOperationHandler
                        processes requirement
                                ?
                        Query 1: Find Policy
                        WHERE PolicyName = "Lookups.Delete"
                        Found? ? Get PolicyId
                                ?
                        Query 2: Get User's Roles
                        WHERE UserId = {userId}
                                ?
                        Query 3: Check Role-Policy Map
                        WHERE RoleId IN (user roles)
                        AND PolicyId = (from Query 1)
                                ?
                    ??????????????????????????????
                    ?                            ?
              Found mapping?                 Not found?
                    YES                          NO
                    ?                            ?
              Allow ?                       Deny ?
              (200 OK)                       (403 Forbidden)
```

---

## Module-Operation Pattern

```
Every policy follows this pattern: "Module.Operation"

Examples:

Lookups Module
?? Lookups.View
?? Lookups.Print
?? Lookups.Create
?? Lookups.Edit
?? Lookups.Delete
?? Lookups.Manage
?? Lookups.Admin

Users Module
?? Users.View
?? Users.Print
?? Users.Create
?? Users.Edit
?? Users.Delete
?? Users.Manage
?? Users.Admin

Roles Module
?? Roles.View
?? Roles.Print
?? ...
?? Roles.Admin

(Plus: Patients, Appointments, Prescriptions)

Total: 7 modules × 7 operations = 49 policies
All stored in master.PolicyMaster
ALL parsed at runtime
ZERO hardcoded
```

---

## Status Dashboard

```
??????????????????????????????????????????????????????
?           IMPLEMENTATION STATUS                    ?
??????????????????????????????????????????????????????
?                                                    ?
?  ? Hardcoding Elimination          COMPLETE      ?
?  ? Constants Removal               COMPLETE      ?
?  ? Runtime Parsing                 ACTIVE        ?
?  ? Database Validation             ACTIVE        ?
?  ? All Controllers Updated         COMPLETE      ?
?  ? Authorization Handlers          REGISTERED    ?
?  ? Policy Provider                 REGISTERED    ?
?  ? Build Status                    SUCCESS       ?
?  ? Compilation Errors              0             ?
?  ? Warnings                        0             ?
?  ? Production Ready                YES           ?
?                                                    ?
??????????????????????????????????????????????????????
```

---

**This is TRUE enterprise-level database-driven authorization!** ??